{% extends 'base.html.twig' %}

{% block title %}ItemBay | Mes comptes{% endblock %}

{% block body %}
    <div class="container text-white mt-5">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Mes comptes</h2>
            <button class="btn btn-sm btn-primary account-add">
                <i class="fas fa-plus"></i>
                Ajouter un compte
            </button>
        </div>
        {% if app.user.accounts | length <= 0 %}
            <tr>
                <td colspan="3">Aucun compte</td>
            </tr>
        {% else %}
            <div class="account-list-container">
                {% include 'account/list_account.html.twig' %}
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}

    {{ parent() }}
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            hideActiveAccount();
            addAccountsListeners();
            document.querySelector('.account-add').addEventListener('click', async () => {
                sidenav.open();
                sidenav.setTitle('Ajouter un compte');
                await sidenav.setContentFromUrl('/account/add');
                sidenav.hideLoader();
            });
        })

        function addAccountsListeners() {
            document.querySelectorAll('.account-edit').forEach((element) => {
                element.addEventListener('click', async () => {
                    sidenav.open();
                    sidenav.setTitle('Modifier un compte');
                    await sidenav.setContentFromUrl('/account/edit/' + element.dataset.id);
                    sidenav.hideLoader();
                });
            });
            document.querySelectorAll('.account-delete').forEach((element) => {
                element.addEventListener('click', async () => {
                    sidenav.open();
                    sidenav.setTitle('Supprimer un compte');
                    await sidenav.setContentFromUrl('/account/delete/' + element.dataset.id);
                    sidenav.hideLoader();
                });
            });
            document.querySelectorAll('.account-activate').forEach((element) => {
                element.addEventListener('click', async (event) => {
                    if (!event.target.matches('.account-edit, .account-delete, .account-inventory')) {
                        let result = await apiFetch('/account/activate/' + element.dataset.id);
                        if (result.success) refreshAccountList();
                    }
                });
            })
        }

        function refreshAccountList() {
            apiFetch('/account/list').then((result) => {
                setInnerHTML(document.querySelector('.account-list-container'), result.data.html);
                addAccountsListeners();
            })
        }
    </script>

{% endblock %}
